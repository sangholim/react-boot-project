package com.spa.all.todos.web;

import java.util.HashMap;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Scope;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Component;
import org.springframework.web.reactive.function.BodyInserters;
import org.springframework.web.reactive.function.server.ServerRequest;
import org.springframework.web.reactive.function.server.ServerResponse;

import com.spa.all.config.RouteHandler;
import com.spa.all.config.dbc.MysqlConfig;
import com.spa.all.todos.sql.TodosQueryContainer;

import io.r2dbc.spi.Connection;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

@Component
@Scope(value = "prototype")
public class TodosHandler implements RouteHandler{

    @Autowired private MysqlConfig mysqlConfig;
    
    private HashMap result = new HashMap<>();

    private Mono<HashMap> mapper = Mono.just(result);

    public Mono<ServerResponse> todosList(ServerRequest request) {
	  Flux<HashMap<Object, Object>>  flux = Flux.from(pool.create()).concatMap(connection ->  //커넥션 가공 및 1차 변환
	        Flux.from(connection.createStatement("select name, desc, date from test where id_=?ids").bind("ids", "2").execute())
	        .concatMap( result-> //2차 변환
	            result.map((row, rowMetadata)-> {  //결과 재 조립 후 리턴
	                HashMap<Object, Object> item = new HashMap<>();
	                item.put("names", row.get("name",String.class));
	                item.put("desc", row.get("desc",String.class));
	                item.put("date", row.get("date",Object.class));
	                return item;
	            })
	        ).doFinally( (st)->{connection.close();})
	    );	
	return ServerResponse.ok().contentType(MediaType.APPLICATION_JSON)
		.body(BodyInserters.fromProducer(mapper, HashMap.class));
    }
}
